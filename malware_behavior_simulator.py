

#!/usr/bin/env python3
"""
Malware Behavior Simulator (SAFE)
Full single-file tool for academic simulation only.
- Works only inside a sandbox folder you create.
- DOES NOT modify system registry, system files, or network interfaces.
- Use inside a VM.

Usage examples (run from terminal):
  python3 malware_behavior_simulator.py --sandbox ./sandbox_root --profile ransomware --duration 20
  python3 malware_behavior_simulator.py --sandbox ./sandbox_root --profile worm --duration 30

Profiles available: ransomware, worm, spyware, keylogger, cpu_storm

This file is provided as-is for learning and monitoring simulated malware behaviors.
"""

import argparse
import os
import time
import json
import random
import string
from datetime import datetime

# --------------------------
# Helper utilities
# --------------------------

def now():
    return datetime.utcnow().isoformat() + 'Z'


def safe_join(root, *parts):
    path = os.path.abspath(os.path.join(root, *parts))
    if not os.path.commonpath([os.path.abspath(root)]) == os.path.commonpath([os.path.abspath(root), path]):
        raise ValueError('Attempt to escape sandbox')
    return path


class Logger:
    def __init__(self, sandbox):
        self.logpath = safe_join(sandbox, 'simulator.log')

    def log(self, level, msg):
        entry = f"[{now()}] {level}: {msg}\n"
        with open(self.logpath, 'a', encoding='utf-8') as f:
            f.write(entry)
        print(entry, end='')


# --------------------------
# Sandbox init
# --------------------------

def init_sandbox(root):
    # structure is minimal and safe
    folders = [
        'fake_user_files',
        'fake_system',
        'fake_registry',
        'fake_network'
    ]
    for f in folders:
        p = safe_join(root, f)
        os.makedirs(p, exist_ok=True)
    # create a few dummy files to act as "user data"
    for i in range(1, 6):
        fp = safe_join(root, 'fake_user_files', f'doc{i}.txt')
        if not os.path.exists(fp):
            with open(fp, 'w', encoding='utf-8') as fh:
                fh.write(f"DUMMY_USER_FILE {i}\nThis is fake content for testing.\n")
    # create dummy browser store
    bdir = safe_join(root, 'fake_user_files', 'browser_profile')
    os.makedirs(bdir, exist_ok=True)
    cred = safe_join(bdir, 'credentials.json')
    if not os.path.exists(cred):
        with open(cred, 'w', encoding='utf-8') as fh:
            json.dump({'accounts': [{'site': 'example.com', 'user': 'fakeuser', 'pass': 'fakepass'}]}, fh)


# --------------------------
# Behavior implementations (SAFE)
# --------------------------

def behavior_fake_encrypt(sandbox, logger, duration):
    """Simulate encrypting: copy -> rename with .enc_fake extension. No actual crypto."""
    user_dir = safe_join(sandbox, 'fake_user_files')
    files = [os.path.join(user_dir, f) for f in os.listdir(user_dir) if os.path.isfile(os.path.join(user_dir, f))]
    start = time.time()
    idx = 0
    while time.time() - start < duration:
        if not files:
            logger.log('WARN', 'No user files to simulate encrypting.')
            break
        src = files[idx % len(files)]
        dst = src + '.enc_fake'
        try:
            with open(src, 'rb') as r, open(dst, 'wb') as w:
                data = r.read()
                # write back the same data (no encryption) but mark as "encrypted"
                w.write(data)
            logger.log('INFO', f"Simulated encrypt: {os.path.basename(src)} -> {os.path.basename(dst)}")
        except Exception as e:
            logger.log('ERROR', f"Failed to simulate encrypt on {src}: {e}")
        idx += 1
        time.sleep(1)


def behavior_fake_cpu_storm(sandbox, logger, duration):
    """Simulate CPU work but keep it modest and cooperative.
    Performs repeated small math loops; avoids excessive load."""
    logger.log('INFO', 'Starting fake CPU storm (cooperative).')
    start = time.time()
    while time.time() - start < duration:
        # do light computation
        s = 0
        for i in range(10000):
            s += (i * i) % 7
        logger.log('DEBUG', f'CPU step computed value {s}')
        time.sleep(0.5)
    logger.log('INFO', 'Ending fake CPU storm')


def behavior_fake_network_beacon(sandbox, logger, duration):
    """Simulate network beacons by writing events to a file in fake_network."""
    netlog = safe_join(sandbox, 'fake_network', 'beacons.log')
    start = time.time()
    count = 0
    while time.time() - start < duration:
        entry = {'time': now(), 'beacon_id': random.randint(1000, 9999), 'payload': 'FAKE_BEACON'}
        with open(netlog, 'a', encoding='utf-8') as f:
            f.write(json.dumps(entry) + '\n')
        logger.log('INFO', f'Simulated network beacon #{count} -> {entry["beacon_id"]}')
        count += 1
        time.sleep(2)


def behavior_fake_keylogger(sandbox, logger, duration):
    """Simulate keylogging by writing fake keystroke events to fake_user_files/keystrokes.log"""
    kfile = safe_join(sandbox, 'fake_user_files', 'keystrokes.log')
    start = time.time()
    while time.time() - start < duration:
        fake_keystrokes = ''.join(random.choice(string.ascii_letters + string.digits + ' ') for _ in range(random.randint(10, 40)))
        entry = {'time': now(), 'keystrokes': fake_keystrokes}
        with open(kfile, 'a', encoding='utf-8') as f:
            f.write(json.dumps(entry) + '\n')
        logger.log('INFO', f'Simulated keylogger event ({len(fake_keystrokes)} chars)')
        time.sleep(1.5)


def behavior_fake_persistence(sandbox, logger, duration):
    """Simulate persistence attempts by writing to fake_registry. Not touching real registry."""
    regfile = safe_join(sandbox, 'fake_registry', 'registry.json')
    try:
        reg = {}
        if os.path.exists(regfile):
            with open(regfile, 'r', encoding='utf-8') as f:
                reg = json.load(f)
    except Exception:
        reg = {}
    start = time.time()
    attempts = 0
    while time.time() - start < duration:
        key = f"RunKey_{random.randint(1000,9999)}"
        reg[key] = {'path': '/fake/path', 'time': now(), 'note': 'simulated persistence entry'}
        with open(regfile, 'w', encoding='utf-8') as f:
            json.dump(reg, f, indent=2)
        logger.log('WARN', f'Simulated persistence write: {key}')
        attempts += 1
        time.sleep(3)


# --------------------------
# Profile dispatcher
# --------------------------

def run_profile(profile, sandbox, duration, logger):
    if profile == 'ransomware':
        # simulate encryption + persistence + network beaconing
        behavior_fake_encrypt(sandbox, logger, duration)
        behavior_fake_persistence(sandbox, logger, max(6, duration//3))
        behavior_fake_network_beacon(sandbox, logger, max(6, duration//3))
    elif profile == 'worm':
        # simulate scanning (fake) and beaconing
        behavior_fake_network_beacon(sandbox, logger, duration)
        # worm could also create duplicate dummy files
        behavior_fake_encrypt(sandbox, logger, min(5, duration))
    elif profile == 'spyware':
        behavior_fake_keylogger(sandbox, logger, duration)
        behavior_fake_network_beacon(sandbox, logger, min(10, duration))
    elif profile == 'keylogger':
        behavior_fake_keylogger(sandbox, logger, duration)
    elif profile == 'cpu_storm':
        behavior_fake_cpu_storm(sandbox, logger, duration)
    else:
        logger.log('ERROR', f'Unknown profile: {profile}')


# --------------------------
# CLI
# --------------------------

def parse_args():
    p = argparse.ArgumentParser(description='Malware Behavior Simulator (SAFE)')
    p.add_argument('--sandbox', '-s', required=True, help='Path to sandbox root (create and control this)')
    p.add_argument('--profile', '-p', required=True, choices=['ransomware','worm','spyware','keylogger','cpu_storm'], help='Behavior profile to simulate')
    p.add_argument('--duration', '-d', type=int, default=20, help='Duration in seconds for the main behavior')
    return p.parse_args()


def main():
    args = parse_args()
    sandbox = os.path.abspath(args.sandbox)
    os.makedirs(sandbox, exist_ok=True)
    init_sandbox(sandbox)
    logger = Logger(sandbox)

    logger.log('INFO', f'Sandbox initialized at {sandbox}')
    logger.log('INFO', f'Running profile: {args.profile} for {args.duration}s')

    try:
        run_profile(args.profile, sandbox, args.duration, logger)
    except KeyboardInterrupt:
        logger.log('WARN', 'Interrupted by user')

    logger.log('INFO', 'Simulation complete. Review simulator.log and sandbox contents.')


if __name__ == '__main__':
    main()

